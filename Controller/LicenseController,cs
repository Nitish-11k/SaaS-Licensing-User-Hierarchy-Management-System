using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using SaasLicenseSystem.Api.DTOs;
using SaasLicenseSystem.Api.Services;
using System.Security.Claims;

namespace SaasLicenseSystem.Api.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Authorize] 
    public class LicensesController : ControllerBase
    {
        private readonly LicenseService _licenseService;

        public LicensesController(LicenseService licenseService)
        {
            _licenseService = licenseService;
        }

        [HttpPost("create")]
        [Authorize(Roles = "SuperAdmin")] 
            public async Task<IActionResult> CreateLicense([FromBody] CreateLicenseRequest request)
        {
            try
            {
                var tenantId = Guid.Parse(User.FindFirst("TenantId")!.Value);
                var result = await _licenseService.CreateLicenseAsync(tenantId, request);
                return Ok(result);
            }
            catch (Exception ex) { return BadRequest(new { message = ex.Message }); }
        }

        [HttpPost("assign")]
        [Authorize(Roles = "SuperAdmin,Admin")] 
        public async Task<IActionResult> AssignLicense([FromBody] AssignLicenseRequest request)
        {
            try
            {
                var adminId = Guid.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value);
                var tenantId = Guid.Parse(User.FindFirst("TenantId")!.Value);
                await _licenseService.AssignLicenseAsync(adminId, tenantId, request);
                return Ok(new { message = "License assigned successfully." });
            }
            catch (Exception ex) { return BadRequest(new { message = ex.Message }); }
        }


        [HttpPost("validate")]
        public async Task<IActionResult> ValidateMachine([FromBody] MachineHeartbeatRequest request)
        {
            try
            {
                var userId = Guid.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value);
                
                var result = await _licenseService.ValidateMachineAsync(userId, request);
                
                if (!result.IsAllowed)
                    return StatusCode(403, result); 
                
                return Ok(result);
            }
            catch (Exception ex) { return BadRequest(new { message = ex.Message }); }
        }
    }
}